
<?php
require_once('/xampp/htdocs/webdacs/BE/ketnoi.php');

// Xử lý khi người dùng nhấn nút "Thích"
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['action']) && isset($_POST['id'])) {
    $id = intval($_POST['id']);
    
    if ($_POST['action'] == 'like') {
        // Cập nhật số lượt thích trong bảng baiviet
        $sql_update_likes = "UPDATE baiviet SET luotthich = luotthich + 1 WHERE id = ?";
    } elseif ($_POST['action'] == 'like_comment') {
        // Cập nhật số lượt thích trong bảng binhluan
        $sql_update_likes = "UPDATE binhluan SET thichbinhluan = thichbinhluan + 1 WHERE id = ?";
    }

    $stmt_update_likes = $connect->prepare($sql_update_likes);
    $stmt_update_likes->bind_param('i', $id);
    if (!$stmt_update_likes->execute()) {
        die('Lỗi khi cập nhật số lượt thích: ' . $stmt_update_likes->error);
    }
    // Redirect để tránh gửi lại dữ liệu khi người dùng làm mới trang
    header("Location: {$_SERVER['REQUEST_URI']}");
    exit;
}

// Kiểm tra xử lý khi người dùng gửi form thêm bình luận
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['noidung'])) {
    // Lấy dữ liệu từ form
    $baiviet_id = intval($_POST['baiviet_id']);
    session_start();
    $nguoidung_id = $_SESSION['nguoidung_id']; // Lấy từ session
    $noidung = $_POST['noidung'];

    // Kiểm tra xem nguoidung_id có tồn tại trong bảng nguoidung không
    $sql_check_user = "SELECT id FROM nguoidung WHERE id = ?";
    $stmt_check_user = $connect->prepare($sql_check_user);
    $stmt_check_user->bind_param('i', $nguoidung_id);
    $stmt_check_user->execute();
    $result_check_user = $stmt_check_user->get_result();

    if ($result_check_user->num_rows == 0) {
        die('Lỗi: Người dùng không tồn tại.');
    }

    // Chuẩn bị câu lệnh SQL để thêm bình luận vào cơ sở dữ liệu
    $sql_add_comment = "INSERT INTO binhluan (baiviet_id, nguoidung_id, noidung) VALUES (?, ?, ?)";
    $stmt_add_comment = $connect->prepare($sql_add_comment);

    if ($stmt_add_comment === false) {
        die('Lỗi khi chuẩn bị câu lệnh SQL: ' . $connect->error);
    }
    $stmt_add_comment->bind_param('iis', $baiviet_id, $nguoidung_id, $noidung);

    // Thực thi câu lệnh SQL để thêm bình luận
    if (!$stmt_add_comment->execute()) {
        die('Lỗi khi thực thi câu lệnh SQL: ' . $stmt_add_comment->error);
    } else {
        echo 'Thêm bình luận thành công.';
    }
}

// Xử lý khi người dùng truyền chude_id qua URL
if (isset($_GET['chude_id'])) {
    // Lấy chude_id từ URL và đảm bảo rằng nó là số nguyên
    $chude_id = intval($_GET['chude_id']);

    // Viết truy vấn SQL để lấy thông tin chi tiết về bài viết dựa trên chude_id
    $sql_baiviet_detail = "SELECT * FROM baiviet WHERE id = ?";
    $stmt = $connect->prepare($sql_baiviet_detail);
    $stmt->bind_param('i', $chude_id);
    $stmt->execute();
    $result = $stmt->get_result();

    // Kiểm tra kết quả truy vấn
    if ($result && $result->num_rows > 0) {
        // Hiển thị thông tin chi tiết về bài viết
        $baiviet = $result->fetch_assoc();

        // Truy vấn để lấy bình luận liên quan đến bài viết
        $sql_comments = "SELECT binhluan.id AS comment_id, binhluan.noidung AS comment_content, binhluan.ngaytao AS comment_date, nguoidung.username AS author_name, binhluan.thichbinhluan AS comment_likes 
                         FROM binhluan 
                         JOIN nguoidung ON binhluan.nguoidung_id = nguoidung.id 
                         WHERE binhluan.baiviet_id = ?";
        $stmt_comments = $connect->prepare($sql_comments);
        $stmt_comments->bind_param('i', $chude_id);
        $stmt_comments->execute();
        $comments_result = $stmt_comments->get_result();
        ?>

        <!DOCTYPE html>
        <html lang="vi">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title><?php echo htmlspecialchars($baiviet['chude']); ?></title>
            <link rel="stylesheet" href="CSS/styles.css">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
            <style>
            .write-post-btn {
                margin-right: 10px;
            }

            .write-post-btn-container {
                margin-left: 10px; /* Spacing between button and title */
                display: flex;
                justify-content: space-between; /* Evenly distribute child elements */
                align-items: center; /* Align  vertically */
            }

            .comments-section {
                margin-top: 20px; /* Top margin for comments section */
            }

           /* Đảm bảo các bình luận có kích thước giống nhau */
            .comment_baiviet {
                border: 1px solid #ccc; /* Đường viền xung quanh mỗi bình luận */
                border-radius: 5px; /* Góc bo tròn */
                margin-bottom: 15px; /* Khoảng cách giữa các bình luận */
                padding: 10px; /* Khoảng cách bên trong hộp bình luận */
                display: flex; /* Sử dụng flexbox */
                flex-direction: column; /* Đặt các phần tử con theo cột */
                align-items: flex-start; /* Căn chỉnh các phần tử con bắt đầu từ đầu */
            }

            .box-comment-user {
                display: flex;
                justify-content: space-between; /* Phân bố các phần tử đều nhau */
                align-items: center; /* Căn giữa theo chiều dọc */
                width: 100%; /* Đảm bảo độ rộng đầy đủ */
                margin-bottom: 10px; /* Khoảng cách phía dưới */
            }

            .box-comment-act {
                display: flex;
                justify-content: space-between; /* Phân bố các phần tử đều nhau */
                align-items: center; /* Căn giữa theo chiều dọc */
                width: 100%; /* Đảm bảo độ rộng đầy đủ */
                margin-top: 10px; /* Khoảng cách phía trên */
            }
            .box-comment-act .right-cmt {
                margin-left: 600px; /* Đẩy phần tử này sang bên phải */
                
            }
                    
            .left-content {
                flex: 1; /* Phần bên trái sẽ chiếm hết không gian có thể */
                text-align: left; /* Căn chỉnh nội dung về bên trái */
            }

            .right-content {
                display:block;
                flex: 1; /* Phần bên phải sẽ chiếm hết không gian có thể */
                text-align: right; /* Căn chỉnh nội dung về bên phải */
            }

            .rep-comment{
                display: flex;
                justify-content: space-between; /* Căn hai phần tử con một cách đều nhau */
                align-items: center; /* Căn theo chiều dọc */
                margin-top: 5px; /* Khoảng cách với phần nội dung comment */
                border-bottom: 1px solid #eee; /* Đường viền dưới cùng */
                padding-bottom: 5px; /* Khoảng cách phía dưới */  
                       
            }
            .rep-comment-btn,
            .like-comment-btn {
                background-color: #007bff; /* Màu nền */
                color: white; /* Màu chữ */
                border: none; /* Loại bỏ đường viền */
                padding: 5px 10px; /* Độ lớn của nút */
                border-radius: 3px; /* Bo tròn góc */
                cursor: pointer; /* Con trỏ tay khi rê chuột vào */
                margin-left: 3px;
            }

            .rep-comment-btn:hover,
            .like-comment-btn:hover {
                background-color: #0056b3; /* Màu nền khi rê chuột vào */
            }

            
            .table {
                width: 100%; /* Full width table */
                margin-top: 10px; /* Top margin */
            }

            .table p {
                margin: 0; /* Remove default margin for paragraphs inside tables */
            }
            .write-post-btn {
                background-color: #007bff; /* Màu nền */
                color: white; /* Màu chữ */
                border: none; /* Loại bỏ đường viền */
                padding:8px 15px; /* Độ lớn của nút */
                border-radius: 3px; /* Bo tròn góc */
                cursor: pointer; /* Con trỏ tay khi rê chuột vào */
                margin: 3px;
                transition: background-color 0.3s; /* Hiệu ứng chuyển đổi màu nền */
            }

            input[type="submit"] {
            background-color: #007bff; /* Màu nền */
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            }
            input[type="submit"]:hover {
                background-color: #4cae4c;
            }

            </style>
            <script>
                function toggleReplyForm() {
                    var replyForm = document.getElementById('replyForm');
                    if (replyForm.style.display === 'none' || replyForm.style.display === '') {
                        replyForm.style.display = 'block';
                    } else {
                        replyForm.style.display = 'none';
                    }
                }

                document.querySelectorAll('.rep-comment-btn').forEach(function(button) {
                button.addEventListener('click', function() {
                    var commentId = this.getAttribute('data-comment-id');
                    var replyForm = document.getElementById('reply-form-' + commentId);
                    replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
                });
            });
            </script>
        </head>
        <body>
            <div class="logo"><h1>Diễn đàn ô tô</h1></div>
            <header>
                <div class="header-container">
                    <div class="nav">
                        <ul>
                            <li><a href="DienDan.php">Diễn đàn</a></li>
                            <li><a href="TinTuc.php">Tin tức</a></li>
                            <li><a href="ThanhVien.php">Thành viên</a></li>
                            <li><a href="#">Tìm kiếm</a></li>
                            <li><a href="DangXuat.php">Đăng xuất</a></li>
                        </ul>
                    </div>
                </div>
            </header>
            <div class="container">
                <div class="card">
                    <div class="card-content">
                        <div class="card-header">
                            <div>
                                <h2><?php echo htmlspecialchars($baiviet['chude']); ?></h2>
                            </div>
                            <p class="right-card">
                                <h4>Tác giả: <?php echo htmlspecialchars($baiviet['tacgia']); ?></h4>
                            </p>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <tr>
                                    <td>
                                        <p><?php echo nl2br(htmlspecialchars($baiviet['noidung'])); ?></p>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="card-user">
                        <div class="write-post-btn-container">
                            <button class="write-post-btn" onclick="toggleReplyForm()">
                                <i class="far fa-comment"></i> Trả lời
                            </button>
                            <form method="post" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]) . '?chude_id=' . $chude_id; ?>">
                                <input type="hidden" name="id" value="<?php echo $chude_id; ?>">
                                <input type="hidden" name="action" value="like">
                                <button class="write-post-btn">
                                    <i class="fas fa-thumbs-up"></i> Like
                                </button>
                                <?php if ($baiviet['luotthich'] > 0) { ?>
                                    <?php echo htmlspecialchars($baiviet['luotthich']); ?>
                                <?php } ?>
                            </form>
                        </div>
                        <p class="right">
                            <small><?php echo htmlspecialchars($baiviet['ngaydang']); ?></small>
                        </p>
                    </div>
                </div>
                <div id="replyForm" class="reply-form" style="display: none;">
                    <form action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]) . '?chude_id=' . $chude_id; ?>" method="post">
                        <input type="hidden" name="baiviet_id" value="<?php echo $chude_id; ?>">
                        <div>
                            <label for="noidung">Nội dung:</label><br>
                            <textarea id="noidung" name="noidung" rows="4" cols="50" required></textarea><br>
                        </div>
                        <input type="submit" value="Gửi">
                    </form>
                </div>
                <!-- Hiển thị bình luận -->
                <div class="comments-section">
                    <h3>Bình luận</h3>
                    <?php
                    if ($comments_result && $comments_result->num_rows > 0) {
                        while ($comment = $comments_result->fetch_assoc()) {
                            ?>
                            <div class="comment_baiviet">
                                <div class="box-comment-user">
                                    <div class="left-content">
                                        <h3>User: <?php echo htmlspecialchars($comment['author_name']); ?></h3>
                                    </div>
                                    <div class="right-content">
                                        <h5>Trả lời <?php echo htmlspecialchars($baiviet['tacgia']); ?></h5>
                                    </div>
                                </div>
                                <div class="comment_baiviet-content">
                                    <div class="box-comment-body">
                                        <table class="table">
                                            <tr>
                                                <td>
                                                    <p><?php echo nl2br(htmlspecialchars($comment['comment_content'])); ?></p>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="box-comment-act">
                                        <div class="rep-comment">
                                            <button class="rep-comment-btn" data-comment-id="<?php echo $comment['comment_id']; ?>">
                                                <i class="far fa-comment"></i> Trả lời
                                            </button>
                                 

                                            <form method="post" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]) . '?chude_id=' . $chude_id; ?>">
                                                <input type="hidden" name="id" value="<?php echo htmlspecialchars($comment['comment_id']); ?>">
                                                <input type="hidden" name="action" value="like_comment">
                                                <button type="submit" class="like-comment-btn">
                                                    <i class="fas fa-thumbs-up"></i> Like
                                                </button>
                                                <?php echo htmlspecialchars($comment['comment_likes']); ?>
                                            </form>
                                        </div>
                                        <p class="right-cmt">
                                            <small><?php echo htmlspecialchars($comment['comment_date']); ?></small>
                                        </p>
                                        <div class="rep-comment-form" id="reply-form-<?php echo $comment['comment_id']; ?>" style="display: none;">
                                            <form method="POST" action="">
                                                <input type="hidden" name="action" value="reply_comment">
                                                <input type="hidden" name="binhluan_id" value="<?php echo $comment['comment_id']; ?>">
                                                <textarea name="noidung" placeholder="Viết phản hồi..."></textarea>
                                                <button type="submit-repcomment">Gửi</button>
                                            </form>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                        <?php
                        }
                    } else {
                        echo "<p>Chưa có bình luận nào.</p>";
                    }
                    ?>
                </div>
            </div>

            <footer>
                <div class="">
                    <p>&copy; Web by Huu Nghia and Minh Hien</p>
                </div>
            </footer>
        </body>
        </html>
        <?php
    } else {
        echo "Không tìm thấy bài viết.";
    }
} else {
    echo "Chủ đề không được cung cấp.";
}

// Đóng kết nối cơ sở dữ liệu
$connect->close(); 
?>
